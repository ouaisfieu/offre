<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Workstation Desktop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --lilac: #b19cd9;
            --lilac-bright: #c9b3ff;
            --lilac-dim: #9575cd;
            --purple: #8b5cf6;
            --terminal-green: #00ff41;
            --terminal-green-bright: #39ff14;
            --bg-light: #f5f3f7;
            --bg-lighter: #faf9fb;
            --glass-bg: rgba(245, 243, 247, 0.85);
            --text-dark: #2d1b3d;
            --editor-bg: #ffffff;
        }

        @keyframes glow-pulse {
            0%, 100% { filter: drop-shadow(0 0 3px var(--lilac)) drop-shadow(0 0 8px var(--lilac)); }
            50% { filter: drop-shadow(0 0 6px var(--lilac-bright)) drop-shadow(0 0 12px var(--lilac-bright)); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Courier New', monospace;
            background: var(--bg-lighter);
            color: var(--text-dark);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--lilac);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            animation: glow-pulse 3s ease-in-out infinite;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: var(--lilac);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-btn:hover {
            background: var(--lilac-bright);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(177, 156, 217, 0.3);
        }

        .tool-btn.active {
            background: var(--terminal-green);
        }

        .tool-separator {
            width: 1px;
            height: 30px;
            background: #e0e0e0;
            margin: 0 0.5rem;
        }

        .filename-input {
            flex: 1;
            min-width: 200px;
            background: var(--bg-light);
            border: 1px solid var(--lilac-dim);
            color: var(--text-dark);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filename-input:focus {
            outline: none;
            border-color: var(--lilac);
            box-shadow: 0 0 0 3px rgba(177, 156, 217, 0.1);
        }

        .workspace {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr;
            overflow: hidden;
        }

        .sidebar {
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--lilac-dim);
        }

        .sidebar-btn {
            background: var(--lilac);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-btn:hover {
            background: var(--lilac-bright);
        }

        .upload-zone {
            margin: 1rem;
            border: 2px dashed var(--lilac);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            background: var(--bg-light);
            border-color: var(--lilac-bright);
        }

        .upload-zone.drag-over {
            background: var(--bg-light);
            border-color: var(--terminal-green);
        }

        .upload-icon {
            font-size: 2.5rem;
            color: var(--lilac);
            margin-bottom: 0.5rem;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .file-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease;
        }

        .file-item:hover {
            background: var(--bg-light);
        }

        .file-item.active {
            background: var(--lilac);
            color: white;
        }

        .file-item.active .file-actions {
            opacity: 1;
        }

        .file-icon {
            font-size: 1.2rem;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-meta {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.2rem;
        }

        .file-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-item:hover .file-actions {
            opacity: 1;
        }

        .file-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--text-dark);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-item.active .file-action-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .file-action-btn:hover {
            background: rgba(255,100,100,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        .main-content.editor-only {
            grid-template-columns: 1fr;
        }

        .main-content.preview-only {
            grid-template-columns: 1fr;
        }

        .editor-panel, .preview-panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
            border-right: 1px solid #e0e0e0;
        }

        .preview-panel {
            border-right: none;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            background: var(--bg-light);
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--lilac-dim);
        }

        .panel-tools {
            display: flex;
            gap: 0.5rem;
        }

        .panel-tool-btn {
            background: var(--lilac);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .panel-tool-btn:hover {
            background: var(--lilac-bright);
        }

        .editor-textarea {
            flex: 1;
            border: none;
            padding: 2rem;
            font-family: 'Courier New', 'Monaco', monospace;
            font-size: 0.95rem;
            line-height: 1.7;
            resize: none;
        }

        .editor-textarea:focus {
            outline: none;
        }

        .preview-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            line-height: 1.8;
        }

        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            color: var(--lilac-dim);
            margin: 2rem 0 1rem;
            border-bottom: 2px solid var(--lilac);
            padding-bottom: 0.5rem;
        }

        .preview-content h1 { font-size: 2.2rem; }
        .preview-content h2 { font-size: 1.8rem; }
        .preview-content h3 { font-size: 1.5rem; }

        .preview-content p {
            margin: 1rem 0;
        }

        .preview-content a {
            color: var(--purple);
            text-decoration: none;
            border-bottom: 1px solid var(--purple);
        }

        .preview-content code {
            background: rgba(177, 156, 217, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            color: var(--purple);
            font-size: 0.9em;
            border: 1px solid var(--lilac);
        }

        .preview-content pre {
            background: #1a1b26;
            border: 2px solid var(--terminal-green);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            position: relative;
        }

        .preview-content pre code {
            background: none;
            border: none;
            color: var(--terminal-green);
        }

        .code-copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--lilac);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .code-copy-btn:hover {
            background: var(--lilac-bright);
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            border: 2px solid var(--lilac);
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-content th {
            background: var(--lilac);
            color: white;
            padding: 0.8rem;
            text-align: left;
        }

        .preview-content td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .preview-content tr:hover {
            background: var(--bg-light);
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .preview-content blockquote {
            border-left: 4px solid var(--lilac);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: rgba(177, 156, 217, 0.05);
            border-radius: 0 8px 8px 0;
        }

        .preview-content ul, .preview-content ol {
            margin: 1rem 0 1rem 2rem;
        }

        .preview-content li {
            margin: 0.5rem 0;
        }

        .mermaid {
            background: rgba(177, 156, 217, 0.05);
            padding: 2rem;
            border-radius: 8px;
            border: 2px solid var(--lilac);
            margin: 1.5rem 0;
        }

        .stats-bar {
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            border-top: 1px solid #e0e0e0;
            font-size: 0.85rem;
            color: var(--lilac-dim);
            display: flex;
            gap: 2rem;
        }

        /* Modal de lecture */
        .read-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .read-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .read-modal-content {
            background: white;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .read-modal-header {
            background: var(--lilac);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .read-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .read-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .read-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .read-modal-body {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .read-modal-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            background: var(--lilac);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-btn:hover {
            background: var(--lilac-bright);
        }

        .modal-btn.secondary {
            background: #e0e0e0;
            color: var(--text-dark);
        }

        .modal-btn.secondary:hover {
            background: #d0d0d0;
        }

        /* Share Menu */
        .share-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            min-width: 400px;
        }

        .share-menu.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .share-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .share-overlay.active {
            display: block;
        }

        .share-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--lilac-dim);
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .share-option {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-option:hover {
            background: var(--bg-light);
            transform: translateY(-2px);
        }

        .share-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .share-label {
            font-size: 0.85rem;
            color: var(--text-dark);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.active {
            transform: translateY(0);
            opacity: 1;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--lilac);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--lilac-bright);
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìù Markdown Workstation Desktop</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="showAbout()">
                    ‚ùì Aide
                </button>
            </div>
        </header>

        <div class="toolbar">
            <button class="tool-btn" onclick="newFile()" title="Nouveau fichier (Ctrl+N)">
                üìÑ Nouveau
            </button>
            <button class="tool-btn" onclick="saveFile()" title="Sauvegarder (Ctrl+S)">
                üíæ Sauvegarder
            </button>
            <button class="tool-btn" onclick="exportMd()" title="Exporter .md">
                üì• Export MD
            </button>
            <button class="tool-btn" onclick="exportHtml()" title="Exporter HTML">
                üåê Export HTML
            </button>
            
            <div class="tool-separator"></div>
            
            <button class="tool-btn active" id="viewSplit" onclick="setView('split')" title="Vue partag√©e (Ctrl+1)">
                ‚öè Split
            </button>
            <button class="tool-btn" id="viewEditor" onclick="setView('editor')" title="√âditeur seul (Ctrl+2)">
                ‚úèÔ∏è √âditeur
            </button>
            <button class="tool-btn" id="viewPreview" onclick="setView('preview')" title="Aper√ßu seul (Ctrl+3)">
                üëÅÔ∏è Aper√ßu
            </button>
            
            <div class="tool-separator"></div>
            
            <input type="text" class="filename-input" id="filenameInput" placeholder="nom-du-fichier.md" value="">
        </div>

        <div class="workspace">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">üìÅ Fichiers</div>
                    <button class="sidebar-btn" onclick="document.getElementById('fileInput').click()" title="Charger des fichiers">+</button>
                </div>

                <label for="fileInput" class="upload-zone" id="uploadZone">
                    <div class="upload-icon">‚¨ÜÔ∏è</div>
                    <div style="font-weight: 600; margin-bottom: 0.3rem;">Charger des fichiers</div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">Glissez-d√©posez ou cliquez</div>
                </label>
                <input type="file" id="fileInput" accept=".md,.markdown" multiple>

                <div class="file-list" id="fileList"></div>
            </div>

            <div class="main-content" id="mainContent">
                <div class="editor-panel" id="editorPanel">
                    <div class="panel-header">
                        <div class="panel-title">‚úèÔ∏è √âditeur</div>
                        <div class="panel-tools">
                            <button class="panel-tool-btn" onclick="insertText('# ')" title="Titre">H</button>
                            <button class="panel-tool-btn" onclick="insertText('**', '**')" title="Gras (Ctrl+B)">B</button>
                            <button class="panel-tool-btn" onclick="insertText('*', '*')" title="Italique (Ctrl+I)">I</button>
                            <button class="panel-tool-btn" onclick="insertText('`', '`')" title="Code">{ }</button>
                            <button class="panel-tool-btn" onclick="insertText('[', '](url)')" title="Lien (Ctrl+K)">üîó</button>
                            <button class="panel-tool-btn" onclick="insertText('- ')" title="Liste">‚Ä¢</button>
                        </div>
                    </div>
                    <textarea class="editor-textarea" id="editor" placeholder="S√©lectionnez un fichier ou cr√©ez-en un nouveau..."></textarea>
                    <div class="stats-bar">
                        <span>üìù <span id="charCount">0</span> caract√®res</span>
                        <span>üìä <span id="wordCount">0</span> mots</span>
                        <span>üìÑ <span id="lineCount">0</span> lignes</span>
                    </div>
                </div>

                <div class="preview-panel" id="previewPanel">
                    <div class="panel-header">
                        <div class="panel-title">üëÅÔ∏è Aper√ßu en temps r√©el</div>
                        <div class="panel-tools">
                            <button class="panel-tool-btn" onclick="shareCurrentFile()">üì§ Partager</button>
                        </div>
                    </div>
                    <div class="preview-content" id="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de lecture -->
    <div class="read-modal" id="readModal">
        <div class="read-modal-content">
            <div class="read-modal-header">
                <div class="read-modal-title" id="modalTitle">Document</div>
                <button class="read-modal-close" onclick="closeReadModal()">√ó</button>
            </div>
            <div class="read-modal-body">
                <div class="preview-content" id="modalPreview"></div>
            </div>
            <div class="read-modal-actions">
                <button class="modal-btn" onclick="editModalFile()">
                    ‚úèÔ∏è √âditer
                </button>
                <button class="modal-btn" onclick="shareModalFile()">
                    üì§ Partager
                </button>
                <button class="modal-btn secondary" onclick="exportModalFile()">
                    üíæ Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Menu de partage -->
    <div class="share-overlay" id="shareOverlay" onclick="closeShareMenu()"></div>
    <div class="share-menu" id="shareMenu">
        <div class="share-title">üì§ Partager sur</div>
        <div class="share-options">
            <div class="share-option" onclick="shareOn('twitter')">
                <div class="share-icon">üê¶</div>
                <div class="share-label">Twitter</div>
            </div>
            <div class="share-option" onclick="shareOn('facebook')">
                <div class="share-icon">üìò</div>
                <div class="share-label">Facebook</div>
            </div>
            <div class="share-option" onclick="shareOn('linkedin')">
                <div class="share-icon">üíº</div>
                <div class="share-label">LinkedIn</div>
            </div>
            <div class="share-option" onclick="shareOn('whatsapp')">
                <div class="share-icon">üí¨</div>
                <div class="share-label">WhatsApp</div>
            </div>
            <div class="share-option" onclick="shareOn('telegram')">
                <div class="share-icon">‚úàÔ∏è</div>
                <div class="share-label">Telegram</div>
            </div>
            <div class="share-option" onclick="shareOn('reddit')">
                <div class="share-icon">ü§ñ</div>
                <div class="share-label">Reddit</div>
            </div>
            <div class="share-option" onclick="shareOn('email')">
                <div class="share-icon">üìß</div>
                <div class="share-label">Email</div>
            </div>
            <div class="share-option" onclick="shareOn('copy')">
                <div class="share-icon">üìã</div>
                <div class="share-label">Copier</div>
            </div>
        </div>
        <button class="modal-btn secondary" style="width: 100%;" onclick="closeShareMenu()">
            Annuler
        </button>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let files = [];
        let currentFile = null;
        let modalFile = null;
        let currentView = 'split';

        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#b19cd9',
                primaryTextColor: '#2d1b3d',
                primaryBorderColor: '#b19cd9',
                lineColor: '#8b5cf6',
                secondaryColor: '#c9b3ff',
                tertiaryColor: '#f5f3f7'
            }
        });

        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true,
            mangle: false,
            headerIds: true
        });

        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const fileList = document.getElementById('fileList');
        const filenameInput = document.getElementById('filenameInput');
        const mainContent = document.getElementById('mainContent');

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.remove('drag-over');
            });
        });

        uploadZone.addEventListener('drop', (e) => {
            const droppedFiles = Array.from(e.dataTransfer.files);
            handleFiles(droppedFiles);
        });

        fileInput.addEventListener('change', (e) => {
            const selectedFiles = Array.from(e.target.files);
            handleFiles(selectedFiles);
            fileInput.value = '';
        });

        function handleFiles(fileArray) {
            fileArray.forEach(file => {
                if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                    loadFile(file);
                } else {
                    showToast(`‚ùå "${file.name}" n'est pas un fichier Markdown`);
                }
            });
        }

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileData = {
                    name: file.name,
                    content: e.target.result,
                    wordCount: e.target.result.split(/\s+/).length,
                    lines: e.target.result.split('\n').length,
                    date: new Date()
                };
                
                const existingIndex = files.findIndex(f => f.name === file.name);
                if (existingIndex !== -1) {
                    files[existingIndex] = fileData;
                    showToast(`üìù "${file.name}" mis √† jour`);
                } else {
                    files.push(fileData);
                    showToast(`‚úÖ "${file.name}" charg√©`);
                }
                
                updateFileList();
                openFile(existingIndex !== -1 ? existingIndex : files.length - 1);
            };
            reader.readAsText(file);
        }

        function updateFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '<div style="padding: 2rem 1rem; text-align: center; color: var(--lilac-dim); font-size: 0.9rem;">Aucun fichier charg√©</div>';
                return;
            }

            fileList.innerHTML = files.map((file, index) => `
                <div class="file-item ${currentFile && currentFile.name === file.name ? 'active' : ''}" onclick="openFile(${index})">
                    <span class="file-icon">üìÑ</span>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">${file.wordCount} mots ‚Ä¢ ${file.lines} lignes</div>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn" onclick="openFileInModal(event, ${index})" title="Lire">üëÅÔ∏è</button>
                        <button class="file-action-btn" onclick="deleteFile(event, ${index})" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openFile(index) {
            currentFile = files[index];
            editor.value = currentFile.content;
            filenameInput.value = currentFile.name;
            updatePreview();
            updateStats();
            updateFileList();
        }

        function openFileInModal(event, index) {
            event.stopPropagation();
            modalFile = files[index];
            
            document.getElementById('modalTitle').textContent = modalFile.name;
            
            let html = marked.parse(modalFile.content);
            html = html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, 
                '<div class="mermaid">$1</div>');
            
            document.getElementById('modalPreview').innerHTML = html;
            document.getElementById('readModal').classList.add('active');
            
            setTimeout(() => {
                mermaid.run({
                    querySelector: '#modalPreview .mermaid'
                });
                enhanceCodeBlocks('#modalPreview');
            }, 100);
        }

        function closeReadModal() {
            document.getElementById('readModal').classList.remove('active');
            modalFile = null;
        }

        function editModalFile() {
            if (!modalFile) return;
            currentFile = modalFile;
            editor.value = modalFile.content;
            filenameInput.value = modalFile.name;
            updatePreview();
            updateStats();
            updateFileList();
            closeReadModal();
            showToast('‚úèÔ∏è √âdition en cours');
        }

        function shareModalFile() {
            if (!modalFile) return;
            currentFile = modalFile;
            closeReadModal();
            openShareMenu();
        }

        function exportModalFile() {
            if (!modalFile) return;
            
            const blob = new Blob([modalFile.content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = modalFile.name;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üíæ "${modalFile.name}" export√©`);
        }

        function deleteFile(event, index) {
            event.stopPropagation();
            const fileName = files[index].name;
            
            if (confirm(`Supprimer "${fileName}" ?`)) {
                files.splice(index, 1);
                
                if (currentFile && currentFile.name === fileName) {
                    if (files.length > 0) {
                        openFile(Math.min(index, files.length - 1));
                    } else {
                        currentFile = null;
                        editor.value = '';
                        filenameInput.value = '';
                        updatePreview();
                        updateStats();
                    }
                }
                
                updateFileList();
                showToast(`üóëÔ∏è "${fileName}" supprim√©`);
            }
        }

        function newFile() {
            const fileName = `nouveau-${Date.now()}.md`;
            const newFileData = {
                name: fileName,
                content: '# Nouveau document\n\nCommencez √† √©crire ici...',
                wordCount: 5,
                lines: 3,
                date: new Date()
            };
            
            files.push(newFileData);
            currentFile = newFileData;
            
            editor.value = newFileData.content;
            filenameInput.value = newFileData.name;
            updatePreview();
            updateStats();
            updateFileList();
            
            showToast('üìÑ Nouveau fichier cr√©√©');
            editor.focus();
        }

        function saveFile() {
            if (!currentFile) {
                showToast('‚ùå Aucun fichier √† sauvegarder');
                return;
            }
            
            currentFile.content = editor.value;
            currentFile.name = filenameInput.value || currentFile.name;
            currentFile.wordCount = editor.value.split(/\s+/).length;
            currentFile.lines = editor.value.split('\n').length;
            
            const blob = new Blob([currentFile.content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.name;
            a.click();
            URL.revokeObjectURL(url);
            
            updateFileList();
            showToast(`üíæ "${currentFile.name}" sauvegard√©`);
        }

        function exportMd() {
            const content = editor.value;
            const filename = filenameInput.value || currentFile?.name || 'document.md';
            
            if (!content.trim()) {
                showToast('‚ùå Aucun contenu √† exporter');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üì• "${filename}" export√©`);
        }

        function exportHtml() {
            const content = editor.value;
            const filename = (filenameInput.value || currentFile?.name || 'document.md').replace('.md', '.html');
            
            if (!content.trim()) {
                showToast('‚ùå Aucun contenu √† exporter');
                return;
            }
            
            const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${filename.replace('.html', '')}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px; 
            margin: 2rem auto; 
            padding: 0 2rem; 
            line-height: 1.6;
            color: #2d1b3d;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #9575cd;
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #b19cd9;
            padding-bottom: 0.5rem;
        }
        code { 
            background: #f4f4f4; 
            padding: 0.2rem 0.4rem; 
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #8b5cf6;
            border: 1px solid #b19cd9;
        }
        pre { 
            background: #1a1b26; 
            color: #00ff41;
            padding: 1rem; 
            border-radius: 8px; 
            overflow-x: auto;
            border: 2px solid #00ff41;
        }
        pre code {
            background: none;
            border: none;
            color: #00ff41;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            border: 2px solid #b19cd9;
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background: #b19cd9;
            color: white;
            padding: 0.8rem;
            text-align: left;
        }
        td {
            border-bottom: 1px solid #b19cd9;
            padding: 0.6rem 0.8rem;
        }
        tr:hover {
            background: rgba(177, 156, 217, 0.1);
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        blockquote {
            border-left: 4px solid #b19cd9;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: rgba(177, 156, 217, 0.05);
            border-radius: 0 8px 8px 0;
        }
        a {
            color: #8b5cf6;
            text-decoration: none;
            border-bottom: 1px solid #8b5cf6;
        }
        a:hover {
            color: #c9b3ff;
            border-bottom-color: #c9b3ff;
        }
        ul, ol {
            margin: 1rem 0 1rem 2rem;
        }
        li {
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
${preview.innerHTML}
</body>
</html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üåê "${filename}" export√©`);
        }

        function setView(view) {
            currentView = view;
            
            document.getElementById('viewSplit').classList.remove('active');
            document.getElementById('viewEditor').classList.remove('active');
            document.getElementById('viewPreview').classList.remove('active');
            
            mainContent.classList.remove('editor-only', 'preview-only');
            
            if (view === 'split') {
                document.getElementById('viewSplit').classList.add('active');
            } else if (view === 'editor') {
                document.getElementById('viewEditor').classList.add('active');
                mainContent.classList.add('editor-only');
                document.getElementById('previewPanel').style.display = 'none';
            } else if (view === 'preview') {
                document.getElementById('viewPreview').classList.add('active');
                mainContent.classList.add('preview-only');
                document.getElementById('editorPanel').style.display = 'none';
            }
            
            if (view !== 'preview') {
                document.getElementById('editorPanel').style.display = 'flex';
            }
            if (view !== 'editor') {
                document.getElementById('previewPanel').style.display = 'flex';
            }
        }

        function shareCurrentFile() {
            if (!currentFile && editor.value.trim() === '') {
                showToast('‚ùå Aucun contenu √† partager');
                return;
            }
            openShareMenu();
        }

        function openShareMenu() {
            document.getElementById('shareOverlay').classList.add('active');
            document.getElementById('shareMenu').classList.add('active');
        }

        function closeShareMenu() {
            document.getElementById('shareOverlay').classList.remove('active');
            document.getElementById('shareMenu').classList.remove('active');
        }

        function shareOn(platform) {
            const file = currentFile || { name: 'document.md', content: editor.value };
            const text = file.content.substring(0, 500);
            const title = file.name.replace('.md', '');
            
            const urls = {
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(title + '\n\n' + text)}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`,
                linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`,
                whatsapp: `https://wa.me/?text=${encodeURIComponent(title + '\n\n' + text)}`,
                telegram: `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(title)}`,
                reddit: `https://reddit.com/submit?url=${encodeURIComponent(window.location.href)}&title=${encodeURIComponent(title)}`,
                email: `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text)}`
            };
            
            if (platform === 'copy') {
                navigator.clipboard.writeText(file.content).then(() => {
                    showToast('üìã Contenu copi√© dans le presse-papier !');
                    closeShareMenu();
                });
            } else if (urls[platform]) {
                window.open(urls[platform], '_blank');
                closeShareMenu();
                showToast(`üì§ Partag√© sur ${platform} !`);
            }
        }

        // √âditeur
        editor.addEventListener('input', () => {
            if (currentFile) {
                currentFile.content = editor.value;
            }
            updatePreview();
            updateStats();
        });

        function updatePreview() {
            let html = marked.parse(editor.value);
            html = html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, 
                '<div class="mermaid">$1</div>');
            preview.innerHTML = html;
            
            setTimeout(() => {
                mermaid.run({
                    querySelector: '#preview .mermaid'
                });
                enhanceCodeBlocks('#preview');
            }, 100);
        }

        function enhanceCodeBlocks(selector) {
            document.querySelectorAll(`${selector} pre`).forEach(pre => {
                if (!pre.querySelector('.code-copy-btn')) {
                    const code = pre.querySelector('code');
                    if (code) {
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'code-copy-btn';
                        copyBtn.textContent = 'üìã Copier';
                        copyBtn.onclick = () => {
                            navigator.clipboard.writeText(code.textContent).then(() => {
                                copyBtn.textContent = '‚úì Copi√© !';
                                setTimeout(() => {
                                    copyBtn.textContent = 'üìã Copier';
                                }, 2000);
                            });
                        };
                        pre.style.position = 'relative';
                        pre.appendChild(copyBtn);
                    }
                }
            });
        }

        function updateStats() {
            const text = editor.value;
            document.getElementById('charCount').textContent = text.length;
            document.getElementById('wordCount').textContent = text.trim() ? text.trim().split(/\s+/).length : 0;
            document.getElementById('lineCount').textContent = text.split('\n').length;
        }

        function insertText(before, after = '') {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selectedText = text.substring(start, end);
            
            const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
            editor.value = newText;
            
            const newCursorPos = start + before.length + selectedText.length;
            editor.setSelectionRange(newCursorPos, newCursorPos);
            editor.focus();
            
            updatePreview();
            updateStats();
            
            if (currentFile) {
                currentFile.content = editor.value;
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        function showAbout() {
            alert('üìù Markdown Workstation Desktop v2.0\n\n' +
                  'Raccourcis clavier :\n' +
                  '‚Ä¢ Ctrl+N : Nouveau fichier\n' +
                  '‚Ä¢ Ctrl+S : Sauvegarder\n' +
                  '‚Ä¢ Ctrl+E : Exporter MD\n' +
                  '‚Ä¢ Ctrl+B : Gras\n' +
                  '‚Ä¢ Ctrl+I : Italique\n' +
                  '‚Ä¢ Ctrl+K : Lien\n' +
                  '‚Ä¢ Ctrl+1/2/3 : Changer de vue\n\n' +
                  'Fonctionnalit√©s :\n' +
                  '‚Ä¢ √âditeur en temps r√©el\n' +
                  '‚Ä¢ Modal de lecture\n' +
                  '‚Ä¢ Partage r√©seaux sociaux\n' +
                  '‚Ä¢ Export MD et HTML\n' +
                  '‚Ä¢ Support Mermaid\n' +
                  '‚Ä¢ Coloration syntaxique');
        }

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                newFile();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportMd();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === '1') {
                e.preventDefault();
                setView('split');
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '2') {
                e.preventDefault();
                setView('editor');
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '3') {
                e.preventDefault();
                setView('preview');
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                insertText('**', '**');
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                insertText('*', '*');
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                insertText('[', '](url)');
            }

            if (e.key === 'Escape') {
                closeReadModal();
                closeShareMenu();
            }
        });

        // Initialisation
        updateFileList();
        updatePreview();
        updateStats();
    </script>
</body>
</html>
